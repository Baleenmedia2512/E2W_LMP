/**\n * Test script for Follow-up Status Change Notifications\n * \n * This script tests the follow-up status change notification system\n * by simulating various status changes and verifying notifications are created.\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport prisma from '@/shared/lib/db/prisma';\nimport { \n  notifyFollowUpStatusChange, \n  notifyLeadFollowUpStageChange,\n  createNotification \n} from '@/shared/lib/utils/notification-service';\nimport { \n  shouldNotifyFollowUpStatusChange,\n  shouldNotifyLeadStageChange,\n  determineFollowUpStatus \n} from '@/shared/lib/utils/followup-status-utils';\nimport { randomUUID } from 'crypto';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { action, leadId, followUpId } = await request.json();\n    \n    switch (action) {\n      case 'test_followup_status_change':\n        return await testFollowUpStatusChange(followUpId);\n      \n      case 'test_lead_stage_change':\n        return await testLeadStageChange(leadId);\n      \n      case 'test_overdue_detection':\n        return await testOverdueDetection();\n      \n      case 'test_notification_creation':\n        return await testNotificationCreation(leadId);\n      \n      default:\n        return NextResponse.json(\n          { success: false, error: 'Invalid test action' },\n          { status: 400 }\n        );\n    }\n  } catch (error) {\n    console.error('Error in test:', error);\n    return NextResponse.json(\n      { success: false, error: 'Test failed', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Test follow-up status change notifications\n */\nasync function testFollowUpStatusChange(followUpId: string) {\n  console.log('Testing follow-up status change...');\n  \n  // Get existing follow-up\n  const followUp = await prisma.followUp.findUnique({\n    where: { id: followUpId },\n    include: {\n      Lead: { select: { id: true, name: true, assignedToId: true } }\n    }\n  });\n  \n  if (!followUp) {\n    return NextResponse.json(\n      { success: false, error: 'Follow-up not found' },\n      { status: 404 }\n    );\n  }\n  \n  if (!followUp.Lead.assignedToId) {\n    return NextResponse.json(\n      { success: false, error: 'Follow-up lead must be assigned to someone for testing' },\n      { status: 400 }\n    );\n  }\n  \n  const oldStatus = followUp.status;\n  const testStatuses = ['pending', 'completed', 'overdue'];\n  const newStatus = testStatuses.find(s => s !== oldStatus) || 'completed';\n  \n  console.log(`Changing follow-up status from ${oldStatus} to ${newStatus}`);\n  \n  // Update status\n  await prisma.followUp.update({\n    where: { id: followUpId },\n    data: { \n      status: newStatus as any,\n      updatedAt: new Date(),\n      completedAt: newStatus === 'completed' ? new Date() : null,\n    }\n  });\n  \n  // Send notification\n  const notification = await notifyFollowUpStatusChange(\n    followUp.Lead.id,\n    followUp.Lead.name,\n    followUp.Lead.assignedToId,\n    oldStatus,\n    newStatus\n  );\n  \n  return NextResponse.json({\n    success: true,\n    message: 'Follow-up status change test completed',\n    data: {\n      followUpId,\n      oldStatus,\n      newStatus,\n      notificationCreated: !!notification,\n    }\n  });\n}\n\n/**\n * Test lead stage change notifications\n */\nasync function testLeadStageChange(leadId: string) {\n  console.log('Testing lead stage change...');\n  \n  // Get existing lead\n  const lead = await prisma.lead.findUnique({\n    where: { id: leadId },\n    select: { id: true, name: true, status: true, assignedToId: true }\n  });\n  \n  if (!lead) {\n    return NextResponse.json(\n      { success: false, error: 'Lead not found' },\n      { status: 404 }\n    );\n  }\n  \n  if (!lead.assignedToId) {\n    return NextResponse.json(\n      { success: false, error: 'Lead must be assigned to someone for testing' },\n      { status: 400 }\n    );\n  }\n  \n  const oldStatus = lead.status;\n  const testStatus = oldStatus === 'followup' ? 'qualified' : 'followup';\n  \n  console.log(`Changing lead status from ${oldStatus} to ${testStatus}`);\n  \n  // Update lead status\n  await prisma.lead.update({\n    where: { id: leadId },\n    data: { status: testStatus as any }\n  });\n  \n  // Send notification\n  const notification = await notifyLeadFollowUpStageChange(\n    lead.id,\n    lead.name,\n    lead.assignedToId,\n    oldStatus,\n    testStatus\n  );\n  \n  return NextResponse.json({\n    success: true,\n    message: 'Lead stage change test completed',\n    data: {\n      leadId,\n      oldStatus,\n      newStatus: testStatus,\n      notificationCreated: !!notification,\n    }\n  });\n}\n\n/**\n * Test overdue detection logic\n */\nasync function testOverdueDetection() {\n  console.log('Testing overdue detection...');\n  \n  const now = new Date();\n  const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n  \n  // Find pending follow-ups that should be overdue\n  const overdueFollowUps = await prisma.followUp.findMany({\n    where: {\n      status: 'pending',\n      scheduledAt: {\n        lt: now,\n      }\n    },\n    include: {\n      Lead: { select: { id: true, name: true, assignedToId: true } }\n    },\n    take: 1\n  });\n  \n  if (overdueFollowUps.length === 0) {\n    // Create a test overdue follow-up\n    const testLead = await prisma.lead.findFirst({\n      where: { assignedToId: { not: null } },\n      select: { id: true, name: true, assignedToId: true }\n    });\n    \n    if (!testLead) {\n      return NextResponse.json(\n        { success: false, error: 'No assigned leads found for testing' },\n        { status: 400 }\n      );\n    }\n    \n    const testFollowUp = await prisma.followUp.create({\n      data: {\n        id: randomUUID(),\n        leadId: testLead.id,\n        scheduledAt: yesterday,\n        status: 'pending',\n        createdById: testLead.assignedToId!,\n        updatedAt: new Date(),\n      }\n    });\n    \n    console.log('Created test overdue follow-up');\n    \n    return NextResponse.json({\n      success: true,\n      message: 'Overdue detection test completed',\n      data: {\n        testFollowUpId: testFollowUp.id,\n        scheduledAt: yesterday,\n        isOverdue: true,\n        message: 'Created test follow-up scheduled for yesterday',\n      }\n    });\n  }\n  \n  const followUp = overdueFollowUps[0];\n  const daysDiff = Math.ceil((now.getTime() - followUp.scheduledAt.getTime()) / (1000 * 60 * 60 * 24));\n  \n  return NextResponse.json({\n    success: true,\n    message: 'Overdue detection test completed',\n    data: {\n      followUpId: followUp.id,\n      scheduledAt: followUp.scheduledAt,\n      daysOverdue: daysDiff,\n      leadName: followUp.Lead.name,\n    }\n  });\n}\n\n/**\n * Test notification creation\n */\nasync function testNotificationCreation(leadId: string) {\n  console.log('Testing notification creation...');\n  \n  const lead = await prisma.lead.findUnique({\n    where: { id: leadId },\n    select: { id: true, name: true, assignedToId: true }\n  });\n  \n  if (!lead || !lead.assignedToId) {\n    return NextResponse.json(\n      { success: false, error: 'Lead not found or not assigned' },\n      { status: 400 }\n    );\n  }\n  \n  const notification = await createNotification({\n    userId: lead.assignedToId,\n    type: 'info',\n    title: '\ud83e\uddea Test Notification',\n    message: `This is a test notification for lead \"${lead.name}\".`,\n    relatedLeadId: lead.id,\n    metadata: {\n      test: true,\n      timestamp: new Date().toISOString(),\n    }\n  });\n  \n  return NextResponse.json({\n    success: true,\n    message: 'Notification creation test completed',\n    data: {\n      notificationId: notification.id,\n      leadId: lead.id,\n      userId: lead.assignedToId,\n    }\n  });\n}\n\n/**\n * GET endpoint for test interface\n */\nexport async function GET() {\n  return NextResponse.json({\n    success: true,\n    message: 'Follow-up Status Change Notification Test API',\n    availableTests: [\n      {\n        action: 'test_followup_status_change',\n        description: 'Test follow-up status change notifications',\n        parameters: ['followUpId']\n      },\n      {\n        action: 'test_lead_stage_change',\n        description: 'Test lead stage change notifications',\n        parameters: ['leadId']\n      },\n      {\n        action: 'test_overdue_detection',\n        description: 'Test overdue follow-up detection',\n        parameters: []\n      },\n      {\n        action: 'test_notification_creation',\n        description: 'Test basic notification creation',\n        parameters: ['leadId']\n      }\n    ],\n    usage: {\n      method: 'POST',\n      endpoint: '/api/diagnostic/test-followup-notifications',\n      body: {\n        action: 'test_action_name',\n        leadId: 'optional_lead_id',\n        followUpId: 'optional_followup_id'\n      }\n    }\n  });\n}